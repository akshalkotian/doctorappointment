{% extends "base.html" %}

{% block title %}Payment - HealthCare Plus{% endblock %}

{% block extra_css %}
<style>
    .payment-method {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .payment-method:hover {
        border-color: #4f46e5;
        background-color: #f9fafb;
        transform: translateY(-2px);
    }
    .payment-method input[type="radio"]:checked + label {
        border-color: #4f46e5;
        background-color: #eef2ff;
    }
    .payment-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Appointment Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Appointment Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1 small">Doctor</p>
                            <p class="fw-semibold mb-0">{{ doctor.name }}</p>
                            <p class="text-muted small">{{ doctor.specialization }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1 small">Patient</p>
                            <p class="fw-semibold mb-0">{{ appointment.user_name }}</p>
                            <p class="text-muted small">{{ appointment.user_email }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1 small">Appointment Date</p>
                            <p class="fw-semibold mb-0"><i class="fas fa-calendar text-primary me-2"></i>{{ appointment.date }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p class="text-muted mb-1 small">Appointment Time</p>
                            <p class="fw-semibold mb-0"><i class="fas fa-clock text-primary me-2"></i>{{ appointment.time }}</p>
                        </div>
                        <div class="col-12">
                            <p class="text-muted mb-1 small">Reason for Visit</p>
                            <p class="fw-semibold mb-0">{{ appointment.reason }}</p>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Consultation Fee</h5>
                        <h4 class="mb-0 text-primary fw-bold">₹500</h4>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="mb-0 fw-semibold"><i class="fas fa-credit-card me-2"></i>Select Payment Method</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('process_payment', appointment_id=appointment.id) }}" id="paymentForm">
                        <div class="row g-3">
                            <!-- UPI Payment -->
                            <div class="col-md-4">
                                <input type="radio" name="payment_method" value="upi" id="upi" class="d-none" required>
                                <label for="upi" class="payment-method w-100 text-center">
                                    <div class="payment-icon text-primary">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <h6 class="fw-semibold mb-1">UPI</h6>
                                    <p class="text-muted small mb-0">GPay, PhonePe</p>
                                </label>
                            </div>

                            <!-- Card Payment -->
                            <div class="col-md-4">
                                <input type="radio" name="payment_method" value="card" id="card" class="d-none">
                                <label for="card" class="payment-method w-100 text-center">
                                    <div class="payment-icon text-success">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <h6 class="fw-semibold mb-1">Card</h6>
                                    <p class="text-muted small mb-0">Debit / Credit</p>
                                </label>
                            </div>

                            <!-- Net Banking -->
                            <div class="col-md-4">
                                <input type="radio" name="payment_method" value="netbanking" id="netbanking" class="d-none">
                                <label for="netbanking" class="payment-method w-100 text-center">
                                    <div class="payment-icon text-info">
                                        <i class="fas fa-university"></i>
                                    </div>
                                    <h6 class="fw-semibold mb-1">Net Banking</h6>
                                    <p class="text-muted small mb-0">All banks</p>
                                </label>
                            </div>
                        </div>

                        <!-- Dynamic Payment Input Fields -->
                        <div id="paymentInputs" class="mt-4" style="display:none;">
                            <!-- UPI Input -->
                            <div id="upiInputs" class="payment-inputs" style="display:none;">
                                <h6 class="fw-semibold mb-3">Enter UPI ID</h6>
                                <div class="mb-3">
                                    <label class="form-label">UPI ID</label>
                                    <input type="text" class="form-control form-control-lg" name="upi_id" 
                                           placeholder="yourname@upi" pattern="[a-zA-Z0-9._-]+@[a-zA-Z]+" id="upiIdInput">
                                    <small class="text-muted">Example: 9876543210@paytm</small>
                                </div>
                            </div>

                            <!-- Card Inputs -->
                            <div id="cardInputs" class="payment-inputs" style="display:none;">
                                <h6 class="fw-semibold mb-3">Enter Card Details</h6>
                                <div class="mb-3">
                                    <label class="form-label">Card Number</label>
                                    <input type="text" class="form-control form-control-lg" name="card_number" 
                                           placeholder="1234 5678 9012 3456" maxlength="19" id="cardNumberInput">
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control form-control-lg" name="card_expiry" 
                                               placeholder="MM/YY" maxlength="5" id="cardExpiryInput">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">CVV</label>
                                        <input type="text" class="form-control form-control-lg" name="card_cvv" 
                                               placeholder="123" maxlength="3" id="cardCvvInput">
                                    </div>
                                </div>
                            </div>

                            <!-- Net Banking Inputs -->
                            <div id="netbankingInputs" class="payment-inputs" style="display:none;">
                                <h6 class="fw-semibold mb-3">Select Your Bank</h6>
                                <div class="mb-3">
                                    <label class="form-label">Bank Name</label>
                                    <select class="form-select form-select-lg" name="bank_name" id="bankNameInput">
                                        <option value="">Choose Bank...</option>
                                        <option value="SBI">State Bank of India</option>
                                        <option value="HDFC">HDFC Bank</option>
                                        <option value="ICICI">ICICI Bank</option>
                                        <option value="Axis">Axis Bank</option>
                                        <option value="Kotak">Kotak Mahindra Bank</option>
                                        <option value="PNB">Punjab National Bank</option>
                                        <option value="BOB">Bank of Baroda</option>
                                        <option value="Canara">Canara Bank</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow" id="payButton" disabled>
                                <i class="fas fa-lock me-2"></i>Pay ₹{{ doctor.fees }}
                            </button>
                            <a href="{{ url_for('doctors_list') }}" class="btn btn-outline-secondary rounded-pill">
                                Cancel
                            </a>
                        </div>

                        <div class="text-center mt-3">
                            <p class="text-muted small mb-0">
                                <i class="fas fa-shield-alt me-1"></i>
                                Your payment information is secure and encrypted
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Payment method selection with proper show/hide logic
const paymentInputsDiv = document.getElementById('paymentInputs');
const upiInputsDiv = document.getElementById('upiInputs');
const cardInputsDiv = document.getElementById('cardInputs');
const netbankingInputsDiv = document.getElementById('netbankingInputs');
const payButton = document.getElementById('payButton');

// Radio button change handlers
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const selectedMethod = this.value;
        
        // Update visual styling
        document.querySelectorAll('.payment-method').forEach(l => {
            l.style.borderColor = '#e5e7eb';
            l.style.backgroundColor = 'white';
        });
        this.nextElementSibling.style.borderColor = '#4f46e5';
        this.nextElementSibling.style.backgroundColor = '#eef2ff';

        // Hide ALL payment input sections first
        upiInputsDiv.style.display = 'none';
        cardInputsDiv.style.display = 'none';
        netbankingInputsDiv.style.display = 'none';

        // Clear all inputs and remove required attributes
        document.getElementById('upiIdInput').value = '';
        document.getElementById('upiIdInput').required = false;
        document.getElementById('cardNumberInput').value = '';
        document.getElementById('cardNumberInput').required = false;
        document.getElementById('cardExpiryInput').value = '';
        document.getElementById('cardExpiryInput').required = false;
        document.getElementById('cardCvvInput').value = '';
        document.getElementById('cardCvvInput').required = false;
        document.getElementById('bankNameInput').value = '';
        document.getElementById('bankNameInput').required = false;

        // Show ONLY the selected payment method's input fields
        paymentInputsDiv.style.display = 'block';
        
        if (selectedMethod === 'upi') {
            upiInputsDiv.style.display = 'block';
            cardInputsDiv.style.display = 'none';  // Explicitly hide others
            netbankingInputsDiv.style.display = 'none';
            document.getElementById('upiIdInput').required = true;
            payButton.disabled = false;
        } else if (selectedMethod === 'card') {
            upiInputsDiv.style.display = 'none';  // Explicitly hide others
            cardInputsDiv.style.display = 'block';
            netbankingInputsDiv.style.display = 'none';
            document.getElementById('cardNumberInput').required = true;
            document.getElementById('cardExpiryInput').required = true;
            document.getElementById('cardCvvInput').required = true;
            payButton.disabled = false;
        } else if (selectedMethod === 'netbanking') {
            upiInputsDiv.style.display = 'none';  // Explicitly hide others
            cardInputsDiv.style.display = 'none';
            netbankingInputsDiv.style.display = 'block';
            document.getElementById('bankNameInput').required = true;
            payButton.disabled = false;
        }
    });
});

// Format card number input (auto-spacing)
document.getElementById('cardNumberInput').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
});

// Format expiry date input (MM/YY)
document.getElementById('cardExpiryInput').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
    }
    e.target.value = value;
});

// Only allow numbers for CVV
document.getElementById('cardCvvInput').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});
</script>
{% endblock %}

